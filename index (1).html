<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Water Footprint Calculator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            padding: 40px;
            width: 100%;
            max-width: 900px;
            min-height: 600px;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .btn {
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-size: 1.1rem;
            cursor: pointer;
            margin: 10px;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-secondary {
            background: linear-gradient(45deg, #48c9b0, #1abc9c);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e1e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .two-column {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .card h3 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }
        
        .card p {
            color: #666;
            margin-bottom: 20px;
        }
        
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .item-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            text-align: center;
        }
        
        .item-card h4 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .water-info {
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }
        
        .quantity-input {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .quantity-input input {
            width: 80px;
            text-align: center;
        }
        
        .voice-btn {
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2rem;
        }
        
        .voice-btn.active {
            background: #c0392b;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .dashboard {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .suggestions {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            padding: 20px;
            border-radius: 5px;
            margin-top: 20px;
        }
        
        .suggestions h3 {
            color: #27ae60;
            margin-bottom: 15px;
        }
        
        .suggestions ul {
            list-style-type: none;
            padding: 0;
        }
        
        .suggestions li {
            margin-bottom: 10px;
            padding-left: 20px;
            position: relative;
        }
        
        .suggestions li:before {
            content: "üíß";
            position: absolute;
            left: 0;
        }
        
        .back-btn {
            background: #6c757d;
            margin-bottom: 20px;
        }
        
        .camera-section {
            text-align: center;
            margin: 20px 0;
        }
        
        #camera-feed {
            width: 100%;
            max-width: 400px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .alert.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .tab-buttons {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .tab-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 0;
        }
        
        .tab-btn:first-child {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
        }
        
        .tab-btn:last-child {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
        }
        
        .tab-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Welcome Page -->
        <div id="welcome-page" class="page active">
            <div class="header">
                <h1>üíß Water Footprint Calculator</h1>
                <p>Track and optimize your daily water consumption</p>
            </div>
            <div class="two-column">
                <div class="card" onclick="showPage('register-page')">
                    <h3>üÜï New User</h3>
                    <p>Register to start tracking your water footprint</p>
                    <button class="btn">Register Now</button>
                </div>
                <div class="card" onclick="showPage('login-page')">
                    <h3>üë§ Existing User</h3>
                    <p>Login to continue tracking your water usage</p>
                    <button class="btn btn-secondary">Login</button>
                </div>
            </div>
        </div>

        <!-- Register Page -->
        <div id="register-page" class="page">
            <div class="header">
                <h1>Register New Account</h1>
                <p>Choose your registration method</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showRegisterTab('email')">Email & Password</button>
                <button class="tab-btn" onclick="showRegisterTab('camera')">Camera Registration</button>
            </div>
            
            <!-- Email Registration -->
            <div id="email-register" class="register-tab">
                <form id="register-form">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="reg-email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="reg-password" required>
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" id="reg-confirm-password" required>
                    </div>
                    <button type="submit" class="btn">Register</button>
                </form>
            </div>
            
            <!-- Camera Registration -->
            <div id="camera-register" class="register-tab" style="display: none;">
                <div class="camera-section">
                    <p>Use your camera to register (Face recognition simulation)</p>
                    <video id="camera-feed" autoplay style="display: none;"></video>
                    <canvas id="camera-canvas" style="display: none;"></canvas>
                    <div id="camera-placeholder" style="width: 100%; max-width: 400px; height: 300px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <p>Camera feed will appear here</p>
                    </div>
                    <button type="button" class="btn" onclick="startCamera()">Start Camera</button>
                    <button type="button" class="btn btn-secondary" onclick="captureImage()" id="capture-btn" style="display: none;">Capture & Register</button>
                </div>
            </div>
            
            <button class="btn back-btn" onclick="showPage('welcome-page')">Back to Home</button>
            
            <!-- Admin Panel Button (for testing) -->
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="showAdminPanel()" style="background: #6c757d; font-size: 0.9rem; padding: 10px 20px;">
                    üîß Admin Panel (Check Users)
                </button>
            </div>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="page">
            <div class="header">
                <h1>Login to Your Account</h1>
                <p>Choose your login method</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showLoginTab('email')">Email & Password</button>
                <button class="tab-btn" onclick="showLoginTab('camera')">Camera Login</button>
            </div>
            
            <!-- Email Login -->
            <div id="email-login" class="login-tab">
                <form id="login-form">
                    <div class="form-group">
                        <label>Email Address</label>
                        <input type="email" id="login-email" required>
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="login-password" required>
                    </div>
                    <button type="submit" class="btn">Login with Email</button>
                </form>
            </div>
            
            <!-- Camera Login -->
            <div id="camera-login" class="login-tab" style="display: none;">
                <div class="camera-section">
                    <p>Use your camera to login (Face recognition)</p>
                    <video id="login-camera-feed" autoplay style="display: none;"></video>
                    <canvas id="login-camera-canvas" style="display: none;"></canvas>
                    <div id="login-camera-placeholder" style="width: 100%; max-width: 400px; height: 300px; background: #f0f0f0; border: 2px dashed #ccc; display: flex; align-items: center; justify-content: center; margin: 0 auto 15px;">
                        <p>Camera feed will appear here</p>
                    </div>
                    <button type="button" class="btn" onclick="startLoginCamera()">Start Camera Login</button>
                    <button type="button" class="btn btn-secondary" onclick="authenticateWithCamera()" id="login-capture-btn" style="display: none;">Authenticate</button>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px; color: #1976d2;">üì± Camera Login Instructions:</h4>
                        <ul style="text-align: left; color: #666; font-size: 0.9rem;">
                            <li>Click "Start Camera Login" to activate your camera</li>
                            <li>Position your face clearly in the camera view</li>
                            <li>Click "Authenticate" to verify your identity</li>
                            <li>System will match against registered camera users</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <button class="btn back-btn" onclick="showPage('welcome-page')">Back to Home</button>
        </div>

        <!-- User Type Selection Page -->
        <div id="user-type-page" class="page">
            <div class="header">
                <h1>Select Your Category</h1>
                <p>Choose the category that best describes you</p>
            </div>
            <div class="two-column">
                <div class="card" onclick="setUserType('household')">
                    <h3>üè† Household</h3>
                    <p>Track water usage for daily household activities</p>
                    <button class="btn">Select Household</button>
                </div>
                <div class="card" onclick="setUserType('farmer')">
                    <h3>üåæ Farmer</h3>
                    <p>Track water usage for agricultural activities</p>
                    <button class="btn btn-secondary">Select Farmer</button>
                </div>
            </div>
        </div>

        <!-- Household Items Page -->
        <div id="household-page" class="page">
            <div class="header">
                <h1>Household Water Usage</h1>
                <p>Select items and enter quantities used today</p>
            </div>
            
            <div class="items-grid" id="household-items">
                <!-- Household items will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="calculateUsage()">Calculate Water Footprint</button>
                <button class="btn back-btn" onclick="showPage('user-type-page')">Back</button>
            </div>
        </div>

        <!-- Farmer Items Page -->
        <div id="farmer-page" class="page">
            <div class="header">
                <h1>Agricultural Water Usage</h1>
                <p>Select crops and enter quantities produced</p>
            </div>
            
            <div class="items-grid" id="farmer-items">
                <!-- Farmer items will be populated here -->
            </div>
            
            <div style="text-align: center; margin-top: 30px;">
                <button class="btn" onclick="calculateUsage()">Calculate Water Footprint</button>
                <button class="btn back-btn" onclick="showPage('user-type-page')">Back</button>
            </div>
        </div>

        <!-- Dashboard Page -->
        <div id="dashboard-page" class="page">
            <div class="header">
                <h1>Water Usage Dashboard</h1>
                <p>Your water footprint analysis and recommendations</p>
            </div>
            
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="showDashboardTab('daily')">Daily</button>
                <button class="tab-btn" onclick="showDashboardTab('weekly')">Weekly</button>
                <button class="tab-btn" onclick="showDashboardTab('monthly')">Monthly</button>
                <button class="tab-btn" onclick="showDashboardTab('yearly')">Yearly</button>
            </div>
            
            <div class="dashboard">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-usage">0</div>
                        <div class="stat-label">Liters Used</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="efficiency-score">0</div>
                        <div class="stat-label">Efficiency Score</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="savings-potential">0</div>
                        <div class="stat-label">Potential Savings (L)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="items-tracked">0</div>
                        <div class="stat-label">Items Tracked</div>
                    </div>
                </div>
                
                <div class="suggestions">
                    <h3>üí° Water Conservation Suggestions</h3>
                    <ul id="suggestions-list">
                        <!-- Suggestions will be populated here -->
                    </ul>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="goBackToItems()">Add More Items</button>
                <button class="btn back-btn" onclick="showPage('user-type-page')">New Session</button>
            </div>
        </div>
        
        <!-- Admin Panel Page -->
        <div id="admin-panel-page" class="page">
            <div class="header">
                <h1>üîß Admin Panel</h1>
                <p>System monitoring and user management</p>
            </div>
            
            <div class="dashboard">
                <div class="tab-buttons">
                    <button class="tab-btn active" onclick="showAdminTab('users')">üë• Registered Users</button>
                    <button class="tab-btn" onclick="showAdminTab('sessions')">üìä Login Sessions</button>
                    <button class="tab-btn" onclick="showAdminTab('usage')">üíß Usage History</button>
                    <button class="tab-btn" onclick="showAdminTab('system')">‚öôÔ∏è System Info</button>
                </div>
                
                <!-- Users Tab -->
                <div id="admin-users" class="admin-tab">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="total-users">0</div>
                            <div class="stat-label">Total Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="email-users">0</div>
                            <div class="stat-label">Email Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="camera-users">0</div>
                            <div class="stat-label">Camera Users</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="current-user-display">None</div>
                            <div class="stat-label">Current User</div>
                        </div>
                    </div>
                    
                    <div id="users-list" style="margin-top: 20px;">
                        <!-- Users will be populated here -->
                    </div>
                </div>
                
                <!-- Sessions Tab -->
                <div id="admin-sessions" class="admin-tab" style="display: none;">
                    <div id="sessions-list">
                        <!-- Sessions will be populated here -->
                    </div>
                </div>
                
                <!-- Usage Tab -->
                <div id="admin-usage" class="admin-tab" style="display: none;">
                    <div id="usage-summary">
                        <!-- Usage summary will be populated here -->
                    </div>
                </div>
                
                <!-- System Tab -->
                <div id="admin-system" class="admin-tab" style="display: none;">
                    <div id="system-info">
                        <!-- System info will be populated here -->
                    </div>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn" onclick="refreshAdminData()">üîÑ Refresh Data</button>
                <button class="btn" onclick="exportAllData()" style="background: #28a745;">üìä Export All Data</button>
                <button class="btn" onclick="clearAllData()" style="background: #dc3545;">üóëÔ∏è Clear All Data</button>
                <button class="btn back-btn" onclick="showPage('welcome-page')">Back to Home</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables for location and weather
        let currentLocation = null;
        let weatherData = null;
        let soilMoistureData = null;
        let currentUser = null;
        let userType = null;
        let currentUsage = {};
        let recognition = null;
        let currentVoiceInput = null;
        
        // API Keys and URLs (In production, these should be environment variables)
        const WEATHER_API_KEY = 'demo_key'; // Replace with actual API key
        const WEATHER_API_URL = 'https://api.openweathermap.org/data/2.5/weather';
        const GEOCODING_API_URL = 'https://api.openweathermap.org/geo/1.0/reverse';
        
        // Enhanced location detection with IP fallback
        async function detectCurrentLocation() {
            try {
                showAlert('Detecting your location...', 'success');
                
                // Try GPS first
                try {
                    const position = await new Promise((resolve, reject) => {
                        if (!navigator.geolocation) {
                            reject(new Error('Geolocation not supported'));
                            return;
                        }
                        
                        navigator.geolocation.getCurrentPosition(resolve, reject, {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 300000
                        });
                    });
                    
                    const { latitude, longitude } = position.coords;
                    currentLocation = { lat: latitude, lon: longitude };
                    
                    console.log(`GPS Location detected: ${latitude}, ${longitude}`);
                    
                } catch (gpsError) {
                    console.log('GPS failed, trying IP-based location...');
                    
                    // Fallback to IP-based location
                    currentLocation = await getLocationFromIP();
                }
                
                // Get location details and weather
                await Promise.all([
                    getLocationName(currentLocation.lat, currentLocation.lon),
                    getCurrentWeather(currentLocation.lat, currentLocation.lon),
                    getSoilMoistureData(currentLocation.lat, currentLocation.lon)
                ]);
                
                showAlert(`Location detected: ${currentLocation.city}, ${currentLocation.state}`, 'success');
                updateLocationDisplay();
                
            } catch (error) {
                console.error('All location detection methods failed:', error);
                showAlert('Location detection failed. Using default location for demo.', 'error');
                
                // Use default location (Delhi) for demo
                currentLocation = { lat: 28.6139, lon: 77.2090 };
                await Promise.all([
                    getLocationName(28.6139, 77.2090),
                    getCurrentWeather(28.6139, 77.2090),
                    getSoilMoistureData(28.6139, 77.2090)
                ]);
                
                updateLocationDisplay();
            }
        }
        
        // IP-based location detection fallback
        async function getLocationFromIP() {
            try {
                // In a real implementation, you would use services like:
                // - ipapi.co/json/
                // - ipinfo.io/json
                // - freegeoip.app/json/
                
                // For demo, simulate IP-based location detection
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // Return approximate coordinates for a major Indian city
                // This could be based on user's IP or other indicators
                const indianCities = [
                    { name: 'Mumbai', lat: 19.0760, lon: 72.8777, state: 'Maharashtra' },
                    { name: 'Delhi', lat: 28.6139, lon: 77.2090, state: 'Delhi' },
                    { name: 'Bangalore', lat: 12.9716, lon: 77.5946, state: 'Karnataka' },
                    { name: 'Chennai', lat: 13.0827, lon: 80.2707, state: 'Tamil Nadu' },
                    { name: 'Kolkata', lat: 22.5726, lon: 88.3639, state: 'West Bengal' },
                    { name: 'Hyderabad', lat: 17.3850, lon: 78.4867, state: 'Telangana' },
                    { name: 'Pune', lat: 18.5204, lon: 73.8567, state: 'Maharashtra' },
                    { name: 'Ahmedabad', lat: 23.0225, lon: 72.5714, state: 'Gujarat' }
                ];
                
                // Randomly select a city for demo (in real app, this would be based on IP)
                const randomCity = indianCities[Math.floor(Math.random() * indianCities.length)];
                
                console.log(`IP-based location: ${randomCity.name}, ${randomCity.state}`);
                
                return {
                    lat: randomCity.lat,
                    lon: randomCity.lon,
                    city: randomCity.name,
                    state: randomCity.state,
                    method: 'IP-based'
                };
                
            } catch (error) {
                console.error('IP location detection failed:', error);
                throw new Error('IP location detection failed');
            }
        }
        
        async function getLocationName(lat, lon) {
            try {
                // For demo purposes, we'll simulate the geocoding API
                // In production, replace with actual API call
                const mockResponse = await simulateGeocodingAPI(lat, lon);
                
                if (mockResponse && mockResponse.length > 0) {
                    const location = mockResponse[0];
                    currentLocation.city = location.name;
                    currentLocation.state = location.state;
                    currentLocation.country = location.country;
                }
            } catch (error) {
                console.error('Geocoding error:', error);
                // Fallback to coordinate display
                currentLocation.city = `${lat.toFixed(2)}, ${lon.toFixed(2)}`;
            }
        }
        
        async function getCurrentWeather(lat, lon) {
            try {
                // Simulate weather API call for demo
                weatherData = await simulateWeatherAPI(lat, lon);
                
            } catch (error) {
                console.error('Weather API error:', error);
                // Use fallback weather data
                weatherData = {
                    temp: 25,
                    humidity: 60,
                    precipitation: 0,
                    windSpeed: 10,
                    condition: 'Clear'
                };
            }
        }
        
        async function getSoilMoistureData(lat, lon) {
            try {
                // Simulate soil moisture API for demo
                soilMoistureData = await simulateSoilMoistureAPI(lat, lon);
                
            } catch (error) {
                console.error('Soil moisture API error:', error);
                // Use fallback data
                soilMoistureData = {
                    moisture: 45, // percentage
                    temperature: 22,
                    recommendation: 'moderate'
                };
            }
        }
        
        // Enhanced simulation functions with better location coverage
        async function simulateGeocodingAPI(lat, lon) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Enhanced coordinate matching for better location detection
            let mockLocation = { name: 'Unknown', state: 'India', country: 'India' };
            
            // Northern India
            if (lat >= 30 && lat <= 35) {
                if (lon >= 75 && lon <= 78) mockLocation = { name: 'Chandigarh', state: 'Punjab', country: 'India' };
                else if (lon >= 76 && lon <= 79) mockLocation = { name: 'Amritsar', state: 'Punjab', country: 'India' };
                else if (lon >= 74 && lon <= 82) mockLocation = { name: 'Jammu', state: 'Jammu & Kashmir', country: 'India' };
                else mockLocation.state = 'Punjab';
            }
            // Delhi NCR Region
            else if (lat >= 28 && lat <= 29.5) {
                if (lon >= 76.5 && lon <= 77.5) mockLocation = { name: 'Delhi', state: 'Delhi', country: 'India' };
                else if (lon >= 77 && lon <= 78) mockLocation = { name: 'Gurgaon', state: 'Haryana', country: 'India' };
                else if (lon >= 76 && lon <= 78) mockLocation = { name: 'Faridabad', state: 'Haryana', country: 'India' };
                else mockLocation.state = 'Haryana';
            }
            // Western India
            else if (lat >= 18 && lat <= 25) {
                if (lon >= 72 && lon <= 73.5) mockLocation = { name: 'Mumbai', state: 'Maharashtra', country: 'India' };
                else if (lon >= 73 && lon <= 75) mockLocation = { name: 'Pune', state: 'Maharashtra', country: 'India' };
                else if (lon >= 70 && lon <= 74 && lat >= 22) mockLocation = { name: 'Ahmedabad', state: 'Gujarat', country: 'India' };
                else if (lon >= 68 && lon <= 75) mockLocation.state = 'Gujarat';
                else mockLocation.state = 'Maharashtra';
            }
            // Southern India
            else if (lat >= 8 && lat <= 18) {
                if (lon >= 77 && lon <= 78 && lat >= 12 && lat <= 13.5) mockLocation = { name: 'Bangalore', state: 'Karnataka', country: 'India' };
                else if (lon >= 80 && lon <= 81 && lat >= 13 && lat <= 14) mockLocation = { name: 'Chennai', state: 'Tamil Nadu', country: 'India' };
                else if (lon >= 78 && lon <= 79 && lat >= 17 && lat <= 18) mockLocation = { name: 'Hyderabad', state: 'Telangana', country: 'India' };
                else if (lon >= 76 && lon <= 77 && lat >= 9 && lat <= 10) mockLocation = { name: 'Kochi', state: 'Kerala', country: 'India' };
                else if (lon >= 76 && lon <= 79) {
                    if (lat >= 14) mockLocation.state = 'Karnataka';
                    else mockLocation.state = 'Kerala';
                }
                else if (lon >= 78 && lon <= 82) {
                    if (lat >= 16) mockLocation.state = 'Telangana';
                    else mockLocation.state = 'Tamil Nadu';
                }
                else mockLocation.state = 'Tamil Nadu';
            }
            // Eastern India
            else if (lat >= 20 && lat <= 28) {
                if (lon >= 88 && lon <= 89 && lat >= 22 && lat <= 23) mockLocation = { name: 'Kolkata', state: 'West Bengal', country: 'India' };
                else if (lon >= 85 && lon <= 87 && lat >= 25 && lat <= 26) mockLocation = { name: 'Patna', state: 'Bihar', country: 'India' };
                else if (lon >= 83 && lon <= 88) {
                    if (lat >= 25) mockLocation.state = 'Bihar';
                    else if (lat >= 22) mockLocation.state = 'West Bengal';
                    else mockLocation.state = 'Odisha';
                }
                else if (lon >= 80 && lon <= 84) mockLocation.state = 'Jharkhand';
                else mockLocation.state = 'Odisha';
            }
            // Central India
            else if (lat >= 21 && lat <= 26) {
                if (lon >= 77 && lon <= 79 && lat >= 23 && lat <= 24) mockLocation = { name: 'Bhopal', state: 'Madhya Pradesh', country: 'India' };
                else if (lon >= 78 && lon <= 82) mockLocation.state = 'Madhya Pradesh';
                else if (lon >= 75 && lon <= 78) mockLocation.state = 'Rajasthan';
                else if (lon >= 82 && lon <= 85) mockLocation.state = 'Chhattisgarh';
                else mockLocation.state = 'Madhya Pradesh';
            }
            // Rajasthan
            else if (lat >= 24 && lat <= 30) {
                if (lon >= 70 && lon <= 78) {
                    if (lon >= 75 && lon <= 76 && lat >= 26 && lat <= 27) mockLocation = { name: 'Jaipur', state: 'Rajasthan', country: 'India' };
                    else mockLocation = { name: 'Rajasthan City', state: 'Rajasthan', country: 'India' };
                }
            }
            // Northeast India
            else if (lat >= 23 && lat <= 29) {
                if (lon >= 89 && lon <= 98) {
                    if (lon >= 91 && lon <= 92 && lat >= 26 && lat <= 27) mockLocation = { name: 'Guwahati', state: 'Assam', country: 'India' };
                    else mockLocation.state = 'Assam';
                }
            }
            
            // If still unknown, make an educated guess based on coordinates
            if (mockLocation.state === 'India') {
                if (lat >= 25) {
                    if (lon <= 75) mockLocation.state = 'Rajasthan';
                    else if (lon <= 80) mockLocation.state = 'Uttar Pradesh';
                    else if (lon <= 85) mockLocation.state = 'Bihar';
                    else mockLocation.state = 'Assam';
                } else if (lat >= 20) {
                    if (lon <= 75) mockLocation.state = 'Gujarat';
                    else if (lon <= 80) mockLocation.state = 'Maharashtra';
                    else if (lon <= 85) mockLocation.state = 'Odisha';
                    else mockLocation.state = 'West Bengal';
                } else {
                    if (lon <= 77) mockLocation.state = 'Karnataka';
                    else if (lon <= 80) mockLocation.state = 'Tamil Nadu';
                    else mockLocation.state = 'Andhra Pradesh';
                }
                
                mockLocation.name = `${mockLocation.state} Region`;
            }
            
            return [mockLocation];
        }
        
        async function simulateWeatherAPI(lat, lon) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1500));
            
            // Generate realistic weather data based on location and season
            const month = new Date().getMonth();
            const isWinterMonth = month >= 10 || month <= 2;
            const isSummerMonth = month >= 3 && month <= 5;
            const isMonsoonMonth = month >= 6 && month <= 9;
            
            let baseTemp = 25;
            let humidity = 60;
            let precipitation = 0;
            
            if (isWinterMonth) {
                baseTemp = Math.random() * 10 + 15; // 15-25¬∞C
                humidity = Math.random() * 20 + 40; // 40-60%
                precipitation = Math.random() * 2; // 0-2mm
            } else if (isSummerMonth) {
                baseTemp = Math.random() * 15 + 30; // 30-45¬∞C
                humidity = Math.random() * 20 + 30; // 30-50%
                precipitation = Math.random() * 5; // 0-5mm
            } else if (isMonsoonMonth) {
                baseTemp = Math.random() * 8 + 25; // 25-33¬∞C
                humidity = Math.random() * 30 + 70; // 70-100%
                precipitation = Math.random() * 50 + 10; // 10-60mm
            }
            
            return {
                temp: Math.round(baseTemp),
                humidity: Math.round(humidity),
                precipitation: Math.round(precipitation * 10) / 10,
                windSpeed: Math.round(Math.random() * 20 + 5),
                condition: precipitation > 5 ? 'Rainy' : humidity > 80 ? 'Humid' : baseTemp > 35 ? 'Hot' : 'Clear',
                timestamp: new Date().toISOString()
            };
        }
        
        async function simulateSoilMoistureAPI(lat, lon) {
            // Simulate API delay
            await new Promise(resolve => setTimeout(resolve, 1200));
            
            // Calculate soil moisture based on weather
            let baseMoisture = 50;
            
            if (weatherData) {
                // Adjust based on recent precipitation and temperature
                baseMoisture += weatherData.precipitation * 2; // Rain increases moisture
                baseMoisture -= (weatherData.temp - 25) * 0.5; // Heat decreases moisture
                baseMoisture += (weatherData.humidity - 50) * 0.2; // Humidity affects soil
            }
            
            // Keep within realistic range
            baseMoisture = Math.max(10, Math.min(90, baseMoisture));
            
            let recommendation = 'moderate';
            if (baseMoisture < 30) recommendation = 'high'; // Dry soil needs more water
            else if (baseMoisture > 70) recommendation = 'low'; // Wet soil needs less water
            
            return {
                moisture: Math.round(baseMoisture),
                temperature: weatherData ? weatherData.temp - 3 : 22,
                recommendation: recommendation,
                timestamp: new Date().toISOString()
            };
        }
        
        function updateLocationDisplay() {
            if (!currentLocation) return;
            
            // Update location dropdown if it exists
            const locationSelect = document.getElementById('farm-location');
            if (locationSelect && currentLocation.state) {
                // Try to match detected state with dropdown options
                for (let option of locationSelect.options) {
                    if (option.value === currentLocation.state) {
                        locationSelect.value = currentLocation.state;
                        break;
                    }
                }
                
                // Remove existing location info
                const existingInfo = document.getElementById('detected-location-info');
                if (existingInfo) {
                    existingInfo.remove();
                }
                
                // Add detected location info with coordinates for debugging
                const infoDiv = document.createElement('div');
                infoDiv.id = 'detected-location-info';
                infoDiv.style.cssText = `
                    background: #e8f5e8;
                    padding: 15px;
                    border-radius: 8px;
                    margin-top: 10px;
                    font-size: 0.9rem;
                    border-left: 4px solid #27ae60;
                `;
                
                const locationMethod = currentLocation.method || 'GPS';
                const coordinates = `${currentLocation.lat.toFixed(4)}, ${currentLocation.lon.toFixed(4)}`;
                
                infoDiv.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 10px;">
                        <strong style="color: #27ae60;">üìç Location Detected (${locationMethod})</strong>
                        <button onclick="detectCurrentLocation()" style="background: #27ae60; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.8rem; cursor: pointer;">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                        <div>
                            <strong>üèôÔ∏è Location:</strong> ${currentLocation.city}, ${currentLocation.state}<br>
                            <small style="color: #666;">Coordinates: ${coordinates}</small>
                        </div>
                        <div>
                            <strong>üå°Ô∏è Weather:</strong> ${weatherData?.temp}¬∞C, ${weatherData?.condition}<br>
                            <small style="color: #666;">Humidity: ${weatherData?.humidity}%</small>
                        </div>
                    </div>
                    <div style="background: rgba(255,255,255,0.7); padding: 10px; border-radius: 5px;">
                        <strong>üå± Soil Status:</strong> ${soilMoistureData?.moisture}% moisture 
                        <span style="color: ${soilMoistureData?.recommendation === 'high' ? '#dc3545' : 
                                                soilMoistureData?.recommendation === 'low' ? '#28a745' : '#ffc107'};">
                            (${soilMoistureData?.recommendation} watering recommended)
                        </span>
                    </div>
                `;
                
                locationSelect.parentNode.appendChild(infoDiv);
                
                // Also add a location debug button for testing
                if (!document.getElementById('location-debug-btn')) {
                    const debugBtn = document.createElement('button');
                    debugBtn.id = 'location-debug-btn';
                    debugBtn.className = 'btn';
                    debugBtn.style.cssText = `
                        font-size: 0.8rem; 
                        padding: 5px 10px; 
                        margin-top: 10px; 
                        background: #6c757d;
                    `;
                    debugBtn.textContent = 'üîß Debug Location';
                    debugBtn.onclick = showLocationDebug;
                    
                    infoDiv.appendChild(debugBtn);
                }
            }
        }
        
        // Location debugging function
        function showLocationDebug() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;
            
            const debugInfo = currentLocation ? `
                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #495057; margin-bottom: 10px;">üìç Current Location Data</h4>
                    <p><strong>Detection Method:</strong> ${currentLocation.method || 'GPS'}</p>
                    <p><strong>Latitude:</strong> ${currentLocation.lat}</p>
                    <p><strong>Longitude:</strong> ${currentLocation.lon}</p>
                    <p><strong>City:</strong> ${currentLocation.city || 'Not determined'}</p>
                    <p><strong>State:</strong> ${currentLocation.state || 'Not determined'}</p>
                    <p><strong>Timestamp:</strong> ${new Date().toLocaleString()}</p>
                </div>
                
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #1976d2; margin-bottom: 10px;">üå°Ô∏è Weather Data</h4>
                    <p><strong>Temperature:</strong> ${weatherData?.temp}¬∞C</p>
                    <p><strong>Condition:</strong> ${weatherData?.condition}</p>
                    <p><strong>Humidity:</strong> ${weatherData?.humidity}%</p>
                    <p><strong>Precipitation:</strong> ${weatherData?.precipitation}mm</p>
                    <p><strong>Wind Speed:</strong> ${weatherData?.windSpeed} km/h</p>
                </div>
                
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üå± Soil Data</h4>
                    <p><strong>Moisture Level:</strong> ${soilMoistureData?.moisture}%</p>
                    <p><strong>Soil Temperature:</strong> ${soilMoistureData?.temperature}¬∞C</p>
                    <p><strong>Watering Recommendation:</strong> ${soilMoistureData?.recommendation}</p>
                </div>
            ` : '<p>No location data available. Try detecting location first.</p>';
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                
                <h3 style="color: #333; margin-bottom: 20px;">üîß Location Debug Information</h3>
                
                ${debugInfo}
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üõ†Ô∏è Troubleshooting</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #856404;">
                        <li>If location shows "Unknown", the coordinates may be outside our database coverage</li>
                        <li>GPS detection requires HTTPS and location permissions</li>
                        <li>IP-based detection is used as fallback when GPS fails</li>
                        <li>Weather and soil data are simulated for demonstration</li>
                    </ul>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.remove(); detectCurrentLocation()" class="btn">
                        üîÑ Retry Location Detection
                    </button>
                    <button onclick="this.parentElement.parentElement.remove(); testCoordinates()" class="btn btn-secondary" style="margin-left: 10px;">
                        üìç Test Custom Coordinates
                    </button>
                </div>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
        }
        
        // Test custom coordinates function
        async function testCoordinates() {
            const lat = parseFloat(prompt('Enter latitude (e.g., 28.6139 for Delhi):') || '28.6139');
            const lon = parseFloat(prompt('Enter longitude (e.g., 77.2090 for Delhi):') || '77.2090');
            
            if (isNaN(lat) || isNaN(lon)) {
                showAlert('Invalid coordinates entered', 'error');
                return;
            }
            
            currentLocation = { lat, lon };
            showAlert(`Testing coordinates: ${lat}, ${lon}`, 'success');
            
            await Promise.all([
                getLocationName(lat, lon),
                getCurrentWeather(lat, lon),
                getSoilMoistureData(lat, lon)
            ]);
            
            updateLocationDisplay();
        }
        
        function fallbackToManualLocation() {
            showAlert('Please manually select your location from the dropdown', 'error');
        }
        
        // Smart irrigation recommendation based on real-time data
        async function getSmartIrrigationRecommendation() {
            if (!weatherData || !soilMoistureData) {
                showAlert('Getting current weather conditions...', 'success');
                
                if (currentLocation) {
                    await Promise.all([
                        getCurrentWeather(currentLocation.lat, currentLocation.lon),
                        getSoilMoistureData(currentLocation.lat, currentLocation.lon)
                    ]);
                } else {
                    // Use default location for demo
                    await Promise.all([
                        getCurrentWeather(28.6139, 77.2090), // Delhi coordinates
                        getSoilMoistureData(28.6139, 77.2090)
                    ]);
                }
            }
            
            generateSmartRecommendations();
        }
        
        function generateSmartRecommendations() {
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 700px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;
            
            // Generate recommendations based on current conditions
            let irrigationRecommendation = 'Drip Irrigation';
            let wateringFrequency = 'Daily';
            let wateringTime = 'Early Morning (6-8 AM)';
            let additionalTips = [];
            
            // Weather-based recommendations
            if (weatherData.temp > 35) {
                wateringFrequency = 'Twice daily';
                wateringTime = 'Early morning and evening';
                additionalTips.push('Use shade cloth to protect plants from extreme heat');
                additionalTips.push('Increase mulch thickness to retain moisture');
            } else if (weatherData.temp < 15) {
                wateringFrequency = 'Every 2-3 days';
                additionalTips.push('Water during warmer parts of the day');
                additionalTips.push('Avoid watering in late evening to prevent frost damage');
            }
            
            if (weatherData.humidity > 80) {
                additionalTips.push('Ensure good air circulation to prevent fungal diseases');
                additionalTips.push('Water at soil level to avoid leaf wetness');
            }
            
            if (weatherData.precipitation > 10) {
                wateringFrequency = 'Reduce or skip watering today';
                additionalTips.push('Check soil moisture before watering after rain');
                irrigationRecommendation = 'Monitor natural rainfall - may not need irrigation';
            }
            
            // Soil moisture-based recommendations
            if (soilMoistureData.moisture < 30) {
                wateringFrequency = 'Immediate watering needed';
                additionalTips.push('Deep watering recommended to restore soil moisture');
            } else if (soilMoistureData.moisture > 70) {
                wateringFrequency = 'Skip watering for 1-2 days';
                additionalTips.push('Monitor for signs of overwatering (yellowing leaves)');
            }
            
            // Wind-based recommendations
            if (weatherData.windSpeed > 15) {
                additionalTips.push('Use drip irrigation or soaker hoses - avoid sprinklers due to high wind');
                additionalTips.push('Wind increases evaporation - consider wind barriers');
            }
            
            const currentConditions = weatherData ? `
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px;">üå°Ô∏è Current Conditions</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>Temperature:</strong> ${weatherData.temp}¬∞C</p>
                            <p><strong>Humidity:</strong> ${weatherData.humidity}%</p>
                            <p><strong>Precipitation:</strong> ${weatherData.precipitation}mm</p>
                        </div>
                        <div>
                            <p><strong>Wind Speed:</strong> ${weatherData.windSpeed} km/h</p>
                            <p><strong>Soil Moisture:</strong> ${soilMoistureData.moisture}%</p>
                            <p><strong>Condition:</strong> ${weatherData.condition}</p>
                        </div>
                    </div>
                </div>
            ` : '';
            
            const tipsList = additionalTips.map(tip => `<li>${tip}</li>`).join('');
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                
                <h3 style="color: #333; margin-bottom: 20px;">ü§ñ Smart Irrigation Recommendations</h3>
                
                ${currentConditions}
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">üéØ Today's Recommendations</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <p><strong>üåø Best Irrigation Method:</strong><br>${irrigationRecommendation}</p>
                            <p><strong>‚è∞ Watering Time:</strong><br>${wateringTime}</p>
                        </div>
                        <div>
                            <p><strong>üìÖ Watering Frequency:</strong><br>${wateringFrequency}</p>
                            <p><strong>üíß Priority:</strong><br>${soilMoistureData.recommendation} watering needed</p>
                        </div>
                    </div>
                </div>
                
                ${additionalTips.length > 0 ? `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <h4 style="color: #856404; margin-bottom: 15px;">üí° Additional Tips</h4>
                        <ul style="margin: 0; padding-left: 20px; color: #856404;">
                            ${tipsList}
                        </ul>
                    </div>
                ` : ''}
                
                <div style="background: #f8d7da; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #721c24; margin-bottom: 15px;">üö® Alerts</h4>
                    <p style="margin: 0;">
                        ${weatherData.temp > 40 ? '‚ö†Ô∏è Extreme heat warning - provide shade and extra water' :
                          weatherData.precipitation > 20 ? 'üåßÔ∏è Heavy rain expected - cover sensitive plants' :
                          soilMoistureData.moisture < 20 ? 'üèúÔ∏è Very dry soil - immediate watering required' :
                          soilMoistureData.moisture > 80 ? 'üíß Soil is very wet - risk of root rot' :
                          '‚úÖ Normal conditions - follow standard watering schedule'}
                    </p>
                </div>
                
                <div style="text-align: center; margin-top: 20px;">
                    <button onclick="this.parentElement.parentElement.remove(); updateIrrigationMethod('${irrigationRecommendation === 'Drip Irrigation' ? 'Drip Irrigation' : 'Sprinkler System'}')" class="btn" style="margin: 5px;">
                        ‚úÖ Apply Recommendations
                    </button>
                    <button onclick="refreshWeatherData()" class="btn btn-secondary" style="margin: 5px;">
                        üîÑ Refresh Weather Data
                    </button>
                </div>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
        }
        
        function updateIrrigationMethod(recommendedMethod) {
            const irrigationSelect = document.getElementById('irrigation-method');
            if (irrigationSelect) {
                irrigationSelect.value = recommendedMethod;
                updateWaterCalculations();
                showAlert(`Irrigation method updated to: ${recommendedMethod}`, 'success');
            }
        }
        
        async function refreshWeatherData() {
            showAlert('Refreshing weather data...', 'success');
            
            if (currentLocation) {
                await Promise.all([
                    getCurrentWeather(currentLocation.lat, currentLocation.lon),
                    getSoilMoistureData(currentLocation.lat, currentLocation.lon)
                ]);
            }
            
            // Close current popup and show updated recommendations
            const existingPopup = document.querySelector('[style*="position: fixed"]');
            if (existingPopup) {
                existingPopup.remove();
            }
            
            generateSmartRecommendations();
        }
        const householdItems = {
            'shower': { name: 'Shower (10 min)', water: 150, unit: 'times', efficient: 100 },
            'bath': { name: 'Bath', water: 300, unit: 'times', efficient: 200 },
            'teeth_brushing': { name: 'Teeth Brushing', water: 12, unit: 'times', efficient: 6 },
            'dish_washing': { name: 'Dish Washing', water: 25, unit: 'times', efficient: 15 },
            'laundry': { name: 'Laundry Load', water: 150, unit: 'loads', efficient: 100 },
            'toilet_flush': { name: 'Toilet Flush', water: 9, unit: 'times', efficient: 6 },
            'car_wash': { name: 'Car Wash', water: 150, unit: 'times', efficient: 50 },
            'garden_watering': { name: 'Garden Watering', water: 100, unit: 'times', efficient: 70 },
            'cooking': { name: 'Cooking', water: 30, unit: 'meals', efficient: 20 },
            'drinking': { name: 'Drinking Water', water: 2, unit: 'liters', efficient: 2 }
        };
        
        const farmItems = {
            'arugula': { name: 'Arugula', water: 0.37, unit: 'plant', efficient: 0.30 },
            'sweet_potato': { name: 'Sweet Potato', water: 0.35, unit: 'plant', efficient: 0.28 },
            'radicchio': { name: 'Radicchio', water: 0.35, unit: 'plant', efficient: 0.28 },
            'basil': { name: 'Basil', water: 0.35, unit: 'plant', efficient: 0.28 },
            'chard': { name: 'Chard', water: 0.17, unit: 'plant', efficient: 0.14 },
            'mint': { name: 'Mint', water: 0.29, unit: 'plant', efficient: 0.23 },
            'onion': { name: 'Onion', water: 0.47, unit: 'plant', efficient: 0.38 },
            'strawberry': { name: 'Strawberry', water: 0.40, unit: 'plant', efficient: 0.32 },
            'lavender': { name: 'Lavender', water: 0.38, unit: 'plant', efficient: 0.30 },
            'broccoli': { name: 'Broccoli', water: 0.35, unit: 'plant', efficient: 0.28 },
            'radish': { name: 'Radish', water: 0.27, unit: 'plant', efficient: 0.22 },
            'squash': { name: 'Squash', water: 0.34, unit: 'plant', efficient: 0.27 },
            'cucumber': { name: 'Cucumber', water: 0.46, unit: 'plant', efficient: 0.37 },
            'kale': { name: 'Kale', water: 0.42, unit: 'plant', efficient: 0.34 },
            'corn': { name: 'Corn', water: 0.41, unit: 'plant', efficient: 0.33 },
            'zucchini': { name: 'Zucchini', water: 0.28, unit: 'plant', efficient: 0.22 },
            'eggplant': { name: 'Eggplant', water: 0.49, unit: 'plant', efficient: 0.39 },
            'leek': { name: 'Leek', water: 0.27, unit: 'plant', efficient: 0.22 },
            'cilantro': { name: 'Cilantro', water: 0.45, unit: 'plant', efficient: 0.36 },
            'sage': { name: 'Sage', water: 0.37, unit: 'plant', efficient: 0.30 },
            'fennel': { name: 'Fennel', water: 0.39, unit: 'plant', efficient: 0.31 },
            'oregano': { name: 'Oregano', water: 0.29, unit: 'plant', efficient: 0.23 },
            'lettuce': { name: 'Lettuce', water: 0.35, unit: 'plant', efficient: 0.28 },
            'romaine': { name: 'Romaine', water: 0.29, unit: 'plant', efficient: 0.23 },
            'spinach': { name: 'Spinach', water: 0.36, unit: 'plant', efficient: 0.29 },
            'cauliflower': { name: 'Cauliflower', water: 0.32, unit: 'plant', efficient: 0.26 },
            'celery': { name: 'Celery', water: 0.31, unit: 'plant', efficient: 0.25 },
            'beans': { name: 'Beans', water: 0.30, unit: 'plant', efficient: 0.24 },
            'okra': { name: 'Okra', water: 0.40, unit: 'plant', efficient: 0.32 },
            'pumpkin': { name: 'Pumpkin', water: 0.35, unit: 'plant', efficient: 0.28 },
            'turnip': { name: 'Turnip', water: 0.54, unit: 'plant', efficient: 0.43 },
            'thyme': { name: 'Thyme', water: 0.39, unit: 'plant', efficient: 0.31 },
            'garlic': { name: 'Garlic', water: 0.24, unit: 'plant', efficient: 0.19 },
            'pepper': { name: 'Pepper', water: 0.33, unit: 'plant', efficient: 0.26 },
            'tarragon': { name: 'Tarragon', water: 0.34, unit: 'plant', efficient: 0.27 },
            'beetroot': { name: 'Beetroot', water: 0.43, unit: 'plant', efficient: 0.34 },
            'collard_greens': { name: 'Collard Greens', water: 0.42, unit: 'plant', efficient: 0.34 },
            'sorrel': { name: 'Sorrel', water: 0.30, unit: 'plant', efficient: 0.24 },
            'tomato': { name: 'Tomato', water: 0.33, unit: 'plant', efficient: 0.26 },
            'mustard_greens': { name: 'Mustard Greens', water: 0.26, unit: 'plant', efficient: 0.21 },
            'parsley': { name: 'Parsley', water: 0.31, unit: 'plant', efficient: 0.25 },
            'dill': { name: 'Dill', water: 0.30, unit: 'plant', efficient: 0.24 },
            'potato': { name: 'Potato', water: 0.56, unit: 'plant', efficient: 0.45 },
            'rosemary': { name: 'Rosemary', water: 0.39, unit: 'plant', efficient: 0.31 },
            'peas': { name: 'Peas', water: 0.13, unit: 'plant', efficient: 0.10 },
            'cabbage': { name: 'Cabbage', water: 0.57, unit: 'plant', efficient: 0.46 },
            'chili': { name: 'Chili', water: 0.19, unit: 'plant', efficient: 0.15 },
            'carrot': { name: 'Carrot', water: 0.33, unit: 'plant', efficient: 0.26 }
        };
        
        // Plant irrigation efficiency multipliers
        const irrigationEfficiency = {
            'Drip Irrigation': 1.0,      // Most efficient - 100% of base water use
            'Micro Sprinkler': 1.15,     // 15% more water than drip
            'Sprinkler System': 1.3,     // 30% more water than drip
            'Soaker Hose': 1.2,          // 20% more water than drip
            'Hand Watering': 1.4,        // 40% more water than drip
            'Flood Irrigation': 1.8      // 80% more water than drip
        };
        
        // Real farmer data for benchmarking and insights
        const farmerDatabase = [
            {id: 'F001', crop: 'Rice', area: 2, irrigation: 'Flooding', rainfall: 150, fertilizer: 80, yield: 5000, location: 'Punjab'},
            {id: 'F002', crop: 'Wheat', area: 1.5, irrigation: 'Drip Irrigation', rainfall: 120, fertilizer: 50, yield: 4000, location: 'Haryana'},
            {id: 'F003', crop: 'Sugarcane', area: 3, irrigation: 'Canal Irrigation', rainfall: 200, fertilizer: 100, yield: 10000, location: 'Uttar Pradesh'},
            {id: 'F004', crop: 'Cotton', area: 2.2, irrigation: 'Sprinkler', rainfall: 90, fertilizer: 60, yield: 3000, location: 'Gujarat'},
            {id: 'F005', crop: 'Maize', area: 1.8, irrigation: 'Drip Irrigation', rainfall: 110, fertilizer: 40, yield: 3500, location: 'Maharashtra'},
            {id: 'F006', crop: 'Rice', area: 2.5, irrigation: 'Flooding', rainfall: 140, fertilizer: 85, yield: 6000, location: 'Bihar'},
            {id: 'F007', crop: 'Wheat', area: 1.2, irrigation: 'Canal Irrigation', rainfall: 100, fertilizer: 55, yield: 3800, location: 'Rajasthan'},
            {id: 'F008', crop: 'Sugarcane', area: 2.8, irrigation: 'Drip Irrigation', rainfall: 210, fertilizer: 95, yield: 12000, location: 'Karnataka'},
            {id: 'F009', crop: 'Cotton', area: 2.0, irrigation: 'Flooding', rainfall: 85, fertilizer: 65, yield: 2900, location: 'Madhya Pradesh'},
            {id: 'F010', crop: 'Maize', area: 1.7, irrigation: 'Sprinkler', rainfall: 115, fertilizer: 45, yield: 3400, location: 'Andhra Pradesh'},
            {id: 'F011', crop: 'Rice', area: 3, irrigation: 'Flooding', rainfall: 160, fertilizer: 90, yield: 7000, location: 'Odisha'},
            {id: 'F012', crop: 'Wheat', area: 2, irrigation: 'Drip Irrigation', rainfall: 125, fertilizer: 48, yield: 4200, location: 'Haryana'},
            {id: 'F013', crop: 'Sugarcane', area: 3.5, irrigation: 'Canal Irrigation', rainfall: 190, fertilizer: 105, yield: 15000, location: 'Tamil Nadu'},
            {id: 'F014', crop: 'Cotton', area: 2.4, irrigation: 'Sprinkler', rainfall: 95, fertilizer: 62, yield: 3100, location: 'Telangana'},
            {id: 'F015', crop: 'Maize', area: 2, irrigation: 'Drip Irrigation', rainfall: 130, fertilizer: 42, yield: 3700, location: 'Uttarakhand'},
            {id: 'F016', crop: 'Rice', area: 2.8, irrigation: 'Flooding', rainfall: 155, fertilizer: 88, yield: 6800, location: 'Assam'},
            {id: 'F017', crop: 'Wheat', area: 1.6, irrigation: 'Canal Irrigation', rainfall: 105, fertilizer: 53, yield: 3900, location: 'Chhattisgarh'},
            {id: 'F018', crop: 'Sugarcane', area: 3.2, irrigation: 'Drip Irrigation', rainfall: 205, fertilizer: 98, yield: 13000, location: 'Maharashtra'},
            {id: 'F019', crop: 'Cotton', area: 2.1, irrigation: 'Sprinkler', rainfall: 92, fertilizer: 60, yield: 3050, location: 'Gujarat'},
            {id: 'F020', crop: 'Maize', area: 1.9, irrigation: 'Drip Irrigation', rainfall: 118, fertilizer: 47, yield: 3600, location: 'Andhra Pradesh'}
        ];
        
        // Initialize speech recognition
        function initSpeechRecognition() {
            // Try different speech recognition APIs
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = function() {
                    console.log('Voice recognition started');
                };
                
                recognition.onresult = function(event) {
                    console.log('Voice recognition result:', event.results);
                    const result = event.results[0][0].transcript;
                    if (currentVoiceInput) {
                        currentVoiceInput.value = result;
                        currentVoiceInput.focus();
                        stopVoiceInput();
                        speak(`Voice input captured: ${result}`);
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Speech recognition error:', event.error);
                    let errorMessage = 'Voice recognition failed';
                    
                    switch(event.error) {
                        case 'network':
                            errorMessage = 'Network error - please check your internet connection';
                            break;
                        case 'not-allowed':
                            errorMessage = 'Microphone access denied - please allow microphone permission';
                            break;
                        case 'no-speech':
                            errorMessage = 'No speech detected - please try again';
                            break;
                        case 'audio-capture':
                            errorMessage = 'No microphone found - please check your audio devices';
                            break;
                        case 'service-not-allowed':
                            errorMessage = 'Speech service not allowed - please enable speech recognition';
                            break;
                    }
                    
                    showAlert(errorMessage, 'error');
                    speak(errorMessage);
                    stopVoiceInput();
                };
                
                recognition.onend = function() {
                    console.log('Voice recognition ended');
                    stopVoiceInput();
                };
                
                console.log('Speech recognition initialized successfully');
            } else {
                console.warn('Speech recognition not supported in this browser');
            }
        }
        
        function startVoiceInput(inputElement) {
            if (!recognition) {
                showAlert('Voice recognition not supported in your browser', 'error');
                speak('Voice recognition not supported in your browser');
                return;
            }
            
            // Check if already listening
            if (currentVoiceInput) {
                stopVoiceInput();
                return;
            }
            
            try {
                currentVoiceInput = inputElement;
                const voiceBtn = inputElement.parentNode.querySelector('.voice-btn');
                if (voiceBtn) {
                    voiceBtn.classList.add('active');
                }
                
                // Start recognition
                recognition.start();
                console.log('Starting voice recognition...');
                speak('Listening for your input. Please speak now.');
                
                // Auto-stop after 10 seconds
                setTimeout(() => {
                    if (currentVoiceInput === inputElement) {
                        stopVoiceInput();
                        showAlert('Voice input timeout - please try again', 'error');
                    }
                }, 10000);
                
            } catch (error) {
                console.error('Error starting voice recognition:', error);
                showAlert('Error starting voice recognition', 'error');
                stopVoiceInput();
            }
        }
        
        function stopVoiceInput() {
            if (recognition && currentVoiceInput) {
                try {
                    recognition.stop();
                } catch (error) {
                    console.error('Error stopping recognition:', error);
                }
            }
            
            const activeBtn = document.querySelector('.voice-btn.active');
            if (activeBtn) {
                activeBtn.classList.remove('active');
            }
            currentVoiceInput = null;
        }
        
        // Text-to-speech function
        function speak(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.rate = 0.8;
                utterance.pitch = 1;
                speechSynthesis.speak(utterance);
            }
        }
        
        // Page navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        // Login tabs
        function showLoginTab(tabType) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.login-tab').forEach(tab => tab.style.display = 'none');
            
            event.target.classList.add('active');
            
            if (tabType === 'email') {
                document.getElementById('email-login').style.display = 'block';
            } else {
                document.getElementById('camera-login').style.display = 'block';
            }
        }
        
        // Camera login functionality
        function startLoginCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    const video = document.getElementById('login-camera-feed');
                    const placeholder = document.getElementById('login-camera-placeholder');
                    
                    video.srcObject = stream;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    document.getElementById('login-capture-btn').style.display = 'inline-block';
                    
                    speak('Camera activated. Position yourself in front of the camera and click authenticate when ready.');
                })
                .catch(function(err) {
                    showAlert('Camera access denied or not available', 'error');
                    speak('Camera login failed. Camera access denied or not available.');
                });
        }
        
        function authenticateWithCamera() {
            const video = document.getElementById('login-camera-feed');
            const canvas = document.getElementById('login-camera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Stop camera stream
            const stream = video.srcObject;
            stream.getTracks().forEach(track => track.stop());
            
            // Simulate face authentication
            showAlert('Authenticating... Please wait', 'success');
            speak('Authenticating with camera. Please wait.');
            
            setTimeout(() => {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const cameraUsers = Object.keys(users).filter(key => key.startsWith('camera_'));
                
                if (cameraUsers.length === 0) {
                    showAlert('No camera users found! Please register with camera first.', 'error');
                    speak('Camera authentication failed. No camera users found. Please register with camera first.');
                    
                    // Reset camera view
                    video.style.display = 'none';
                    document.getElementById('login-camera-placeholder').style.display = 'flex';
                    document.getElementById('login-capture-btn').style.display = 'none';
                    return;
                }
                
                // Simulate face recognition authentication
                // In a real app, this would compare the captured image with stored face data
                // For simulation, we'll randomly succeed/fail based on whether camera users exist
                const authSuccess = Math.random() > 0.3; // 70% success rate for demo
                
                if (authSuccess) {
                    // Use first registered camera user for successful auth
                    const authenticatedUser = cameraUsers[0];
                    currentUser = authenticatedUser;
                    recordLoginSession(authenticatedUser, 'camera', 'camera_login');
                    
                    showAlert('Camera authentication successful!', 'success');
                    speak('Camera authentication successful! Welcome back.');
                    
                    setTimeout(() => {
                        showPage('user-type-page');
                    }, 2000);
                } else {
                    showAlert('Camera authentication failed. Face not recognized. Please try again or register first.', 'error');
                    speak('Camera authentication failed. Face not recognized. Please try again or register with camera first.');
                    
                    // Reset camera view for retry
                    video.style.display = 'none';
                    document.getElementById('login-camera-placeholder').style.display = 'flex';
                    document.getElementById('login-capture-btn').style.display = 'none';
                }
                
            }, 3000); // 3 second delay for authentication simulation
        }
        
        function showRegisterTab(tabType) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.register-tab').forEach(tab => tab.style.display = 'none');
            
            event.target.classList.add('active');
            
            if (tabType === 'email') {
                document.getElementById('email-register').style.display = 'block';
            } else {
                document.getElementById('camera-register').style.display = 'block';
            }
        }
        
        // Camera functionality
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    const video = document.getElementById('camera-feed');
                    const placeholder = document.getElementById('camera-placeholder');
                    
                    video.srcObject = stream;
                    video.style.display = 'block';
                    placeholder.style.display = 'none';
                    document.getElementById('capture-btn').style.display = 'inline-block';
                })
                .catch(function(err) {
                    showAlert('Camera access denied or not available', 'error');
                });
        }
        
        function captureImage() {
            const video = document.getElementById('camera-feed');
            const canvas = document.getElementById('camera-canvas');
            const ctx = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Stop camera stream
            const stream = video.srcObject;
            stream.getTracks().forEach(track => track.stop());
            
            // Simulate face registration
            setTimeout(() => {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                const userId = 'camera_' + Date.now();
                users[userId] = { type: 'camera', registered: new Date().toISOString() };
                localStorage.setItem('users', JSON.stringify(users));
                
                currentUser = userId;
                recordLoginSession(userId, 'camera', 'camera_registration');
                showAlert('Camera registration successful!', 'success');
                speak('Camera registration successful! Welcome to Water Footprint Calculator.');
                
                setTimeout(() => {
                    showPage('user-type-page');
                }, 2000);
            }, 2000);
        }
        
        // Registration form
        document.getElementById('register-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            const confirmPassword = document.getElementById('reg-confirm-password').value;
            
            if (password !== confirmPassword) {
                showAlert('Passwords do not match!', 'error');
                speak('Registration failed. Passwords do not match.');
                return;
            }
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (users[email]) {
                showAlert('User already exists!', 'error');
                speak('Registration failed. User already exists.');
                return;
            }
            
            users[email] = { password: password, registered: new Date().toISOString() };
            localStorage.setItem('users', JSON.stringify(users));
            
            currentUser = email;
            recordLoginSession(email, 'email', 'registration');
            showAlert('Registration successful!', 'success');
            speak('Registration successful! Welcome to Water Footprint Calculator.');
            
            setTimeout(() => {
                showPage('user-type-page');
            }, 2000);
        });
        
        // Login form
        document.getElementById('login-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            
            if (!users[email]) {
                showAlert('User not found! Please register first.', 'error');
                speak('Login failed. User not found. Please register first.');
                return;
            }
            
            if (users[email].password !== password) {
                showAlert('Invalid password!', 'error');
                speak('Login failed. Invalid password.');
                return;
            }
            
            currentUser = email;
            recordLoginSession(email, 'email', 'login');
            showAlert('Login successful!', 'success');
            speak('Login successful! Welcome back.');
            
            setTimeout(() => {
                showPage('user-type-page');
            }, 2000);
        });
        
        // User type selection with automatic location detection for farmers
        function setUserType(type) {
            userType = type;
            if (type === 'household') {
                populateItems('household-items', householdItems);
                showPage('household-page');
            } else {
                populateItems('farmer-items', farmItems);
                showPage('farmer-page');
                
                // Auto-detect location for farmers if not already detected
                if (!currentLocation) {
                    setTimeout(() => {
                        if (confirm('Would you like to automatically detect your location for personalized weather-based recommendations?')) {
                            detectCurrentLocation();
                        }
                    }, 1000);
                }
            }
        }
        
        // Populate items with enhanced farmer features
        function populateItems(containerId, items) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            if (containerId === 'farmer-items') {
                // Add farmer profile inputs first
                const profileCard = document.createElement('div');
                profileCard.className = 'item-card';
                profileCard.style.gridColumn = 'span 2';
                profileCard.style.background = '#e8f5e8';
                profileCard.innerHTML = `
                    <h4>üåæ Garden/Farm Profile Setup</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 15px 0;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Farm/Garden Location:</label>
                            <select id="farm-location" style="width: 100%; padding: 8px; border-radius: 5px;">
                                <option value="">Select Location</option>
                                <option value="Punjab">Punjab</option>
                                <option value="Haryana">Haryana</option>
                                <option value="Uttar Pradesh">Uttar Pradesh</option>
                                <option value="Gujarat">Gujarat</option>
                                <option value="Maharashtra">Maharashtra</option>
                                <option value="Bihar">Bihar</option>
                                <option value="Rajasthan">Rajasthan</option>
                                <option value="Karnataka">Karnataka</option>
                                <option value="Madhya Pradesh">Madhya Pradesh</option>
                                <option value="Andhra Pradesh">Andhra Pradesh</option>
                                <option value="Odisha">Odisha</option>
                                <option value="Tamil Nadu">Tamil Nadu</option>
                                <option value="Telangana">Telangana</option>
                                <option value="Uttarakhand">Uttarakhand</option>
                                <option value="Assam">Assam</option>
                                <option value="Chhattisgarh">Chhattisgarh</option>
                                <option value="Other">Other Location</option>
                            </select>
                            <button onclick="detectCurrentLocation()" class="btn btn-secondary" style="margin-top: 8px; font-size: 0.8rem; padding: 6px 12px; width: 100%;">
                                üìç Auto-Detect My Location
                            </button>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: bold;">Irrigation Method:</label>
                            <select id="irrigation-method" style="width: 100%; padding: 8px; border-radius: 5px;" onchange="updateWaterCalculations()">
                                <option value="">Select Method</option>
                                <option value="Drip Irrigation">üåø Drip Irrigation (Most Efficient)</option>
                                <option value="Micro Sprinkler">üíß Micro Sprinkler System</option>
                                <option value="Sprinkler System">üåä Sprinkler System</option>
                                <option value="Soaker Hose">üêç Soaker Hose</option>
                                <option value="Hand Watering">ü™£ Hand Watering (Bucket/Can)</option>
                                <option value="Flood Irrigation">üåä Flood Irrigation (Traditional)</option>
                            </select>
                            <button onclick="getSmartIrrigationRecommendation()" class="btn" style="margin-top: 8px; font-size: 0.8rem; padding: 6px 12px; width: 100%; background: #28a745;">
                                ü§ñ Smart Irrigation Advice
                            </button>
                        </div>
                    </div>
                    <div style="background: #e3f2fd; padding: 10px; border-radius: 5px; margin-top: 10px;">
                        <p style="font-size: 0.9rem; margin: 0; color: #1976d2;">
                            <strong>üîÆ AI Features:</strong> Auto-detect location, real-time weather data, 
                            and personalized irrigation recommendations based on current conditions.
                        </p>
                    </div>
                    <button class="btn btn-secondary" onclick="showPlantWaterGuide()" style="margin-top: 10px;">
                        üìñ Plant Water Requirements Guide
                    </button>
                `;
                container.appendChild(profileCard);
            }
            
            Object.keys(items).forEach(key => {
                const item = items[key];
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                
                if (containerId === 'farmer-items') {
                    itemCard.innerHTML = `
                        <h4>${item.name}</h4>
                        <div class="water-info">${item.water}L per ${item.unit}</div>
                        <div class="water-info" style="color: #27ae60; font-size: 0.9rem;">Efficient: ${item.efficient}L per ${item.unit}</div>
                        <div class="quantity-input">
                            <label>Production (${item.unit}):</label>
                            <input type="number" id="${key}-quantity" min="0" step="0.1" value="0">
                            <button class="voice-btn" onclick="startVoiceInput(document.getElementById('${key}-quantity'))" title="Voice input">üé§</button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-secondary" onclick="showCropBenchmark('${key}')" style="font-size: 0.8rem; padding: 5px 10px;">
                                üìà Regional Data
                            </button>
                        </div>
                    `;
                } else {
                    itemCard.innerHTML = `
                        <h4>${item.name}</h4>
                        <div class="water-info">${item.water}L per ${item.unit}</div>
                        <div class="water-info" style="color: #27ae60; font-size: 0.9rem;">Efficient: ${item.efficient}L per ${item.unit}</div>
                        <div class="quantity-input">
                            <label>Quantity:</label>
                            <input type="number" id="${key}-quantity" min="0" step="0.1" value="0">
                            <button class="voice-btn" onclick="startVoiceInput(document.getElementById('${key}-quantity'))" title="Voice input">üé§</button>
                        </div>
                    `;
                }
                container.appendChild(itemCard);
            });
        }
        
        // Show benchmark data for farmers
        function showBenchmarkData() {
            const location = document.getElementById('farm-location').value;
            const irrigation = document.getElementById('irrigation-method').value;
            
            if (!location) {
                showAlert('Please select your farm location first', 'error');
                return;
            }
            
            const relevantFarmers = farmerDatabase.filter(f => f.location === location);
            
            if (relevantFarmers.length === 0) {
                showAlert('No benchmark data available for selected location', 'error');
                return;
            }
            
            // Create benchmark popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 600px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;
            
            let irrigationData = '';
            if (irrigation) {
                const irrigationFarmers = relevantFarmers.filter(f => f.irrigation === irrigation);
                if (irrigationFarmers.length > 0) {
                    const avgYield = irrigationFarmers.reduce((sum, f) => sum + f.yield, 0) / irrigationFarmers.length;
                    const avgRainfall = irrigationFarmers.reduce((sum, f) => sum + f.rainfall, 0) / irrigationFarmers.length;
                    irrigationData = `
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0;">
                            <h4 style="color: #1976d2; margin-bottom: 10px;">${irrigation} in ${location}</h4>
                            <p><strong>Average Yield:</strong> ${Math.round(avgYield)} kg</p>
                            <p><strong>Average Rainfall:</strong> ${Math.round(avgRainfall)} mm</p>
                            <p><strong>Farmers using this method:</strong> ${irrigationFarmers.length}</p>
                        </div>
                    `;
                }
            }
            
            const cropStats = {};
            relevantFarmers.forEach(f => {
                if (!cropStats[f.crop]) {
                    cropStats[f.crop] = { count: 0, totalYield: 0, totalArea: 0 };
                }
                cropStats[f.crop].count++;
                cropStats[f.crop].totalYield += f.yield;
                cropStats[f.crop].totalArea += f.area;
            });
            
            let cropData = '<h4 style="color: #667eea; margin: 20px 0 10px 0;">Crop Performance in ' + location + '</h4>';
            Object.entries(cropStats).forEach(([crop, stats]) => {
                const avgYield = Math.round(stats.totalYield / stats.count);
                const avgYieldPerHa = Math.round((stats.totalYield / stats.totalArea));
                cropData += `
                    <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px; border-left: 4px solid #667eea;">
                        <strong>${crop}:</strong> ${stats.count} farmers, Avg yield: ${avgYield} kg (${avgYieldPerHa} kg/ha)
                    </div>
                `;
            });
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                <h3 style="color: #333; margin-bottom: 20px;">üìä Regional Benchmark Data</h3>
                <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #27ae60; margin-bottom: 10px;">üìç ${location} Overview</h4>
                    <p><strong>Total Farmers in Database:</strong> ${relevantFarmers.length}</p>
                    <p><strong>Average Farm Size:</strong> ${(relevantFarmers.reduce((sum, f) => sum + f.area, 0) / relevantFarmers.length).toFixed(1)} hectares</p>
                    <p><strong>Average Rainfall:</strong> ${Math.round(relevantFarmers.reduce((sum, f) => sum + f.rainfall, 0) / relevantFarmers.length)} mm</p>
                </div>
                ${irrigationData}
                ${cropData}
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                    <h4 style="color: #856404;">üí° Recommendations</h4>
                    <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
                        <li>Compare your yields with regional averages</li>
                        <li>Consider efficient irrigation methods used by top performers</li>
                        <li>Monitor seasonal rainfall patterns for better water management</li>
                    </ul>
                </div>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
        }
        
        // Admin Panel Functions
        function showAdminPanel() {
            showPage('admin-panel-page');
            refreshAdminData();
        }
        
        function showAdminTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.admin-tab').forEach(tab => tab.style.display = 'none');
            
            event.target.classList.add('active');
            document.getElementById('admin-' + tabName).style.display = 'block';
            
            // Load specific tab data
            if (tabName === 'users') loadUsersData();
            else if (tabName === 'sessions') loadSessionsData();
            else if (tabName === 'usage') loadUsageData();
            else if (tabName === 'system') loadSystemData();
        }
        
        function refreshAdminData() {
            loadUsersData();
        }
        
        function loadUsersData() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const userEntries = Object.entries(users);
            
            const emailUsers = userEntries.filter(([key]) => !key.startsWith('camera_'));
            const cameraUsers = userEntries.filter(([key]) => key.startsWith('camera_'));
            
            // Update stats
            document.getElementById('total-users').textContent = userEntries.length;
            document.getElementById('email-users').textContent = emailUsers.length;
            document.getElementById('camera-users').textContent = cameraUsers.length;
            document.getElementById('current-user-display').textContent = currentUser || 'None';
            
            // Create users list
            const usersList = document.getElementById('users-list');
            usersList.innerHTML = '';
            
            if (userEntries.length === 0) {
                usersList.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No users registered yet</div>';
                return;
            }
            
            userEntries.forEach(([userId, userData], index) => {
                const isEmailUser = !userId.startsWith('camera_');
                const userCard = document.createElement('div');
                userCard.style.cssText = `
                    background: white;
                    border-radius: 10px;
                    padding: 20px;
                    margin: 10px 0;
                    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
                    border-left: 4px solid ${currentUser === userId ? '#28a745' : '#667eea'};
                `;
                
                const registrationDate = userData.registered ? new Date(userData.registered).toLocaleString() : 'Unknown';
                const userType = isEmailUser ? 'üìß Email User' : 'üì∑ Camera User';
                const status = currentUser === userId ? '‚úÖ Currently Logged In' : '‚ö™ Offline';
                
                userCard.innerHTML = `
                    <div style="display: flex; justify-content: between; align-items: center; flex-wrap: wrap; gap: 15px;">
                        <div>
                            <h4 style="margin: 0 0 10px 0; color: #333;">${userType}</h4>
                            <p style="margin: 5px 0; color: #666;"><strong>ID:</strong> ${userId}</p>
                            ${isEmailUser ? `<p style="margin: 5px 0; color: #666;"><strong>Email:</strong> ${userId}</p>` : ''}
                            <p style="margin: 5px 0; color: #666;"><strong>Registered:</strong> ${registrationDate}</p>
                            <p style="margin: 5px 0; color: ${currentUser === userId ? '#28a745' : '#6c757d'};"><strong>Status:</strong> ${status}</p>
                        </div>
                        <div style="text-align: right;">
                            <button onclick="loginAsUser('${userId}')" class="btn btn-secondary" style="font-size: 0.8rem; padding: 8px 15px; margin: 2px;">
                                üîë Login As
                            </button>
                            <button onclick="deleteUser('${userId}')" class="btn" style="background: #dc3545; font-size: 0.8rem; padding: 8px 15px; margin: 2px;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    </div>
                `;
                
                usersList.appendChild(userCard);
            });
        }
        
        function loadSessionsData() {
            const sessions = JSON.parse(localStorage.getItem('login_sessions') || '[]');
            const sessionsList = document.getElementById('sessions-list');
            
            sessionsList.innerHTML = `
                <h3 style="color: #333; margin-bottom: 20px;">Recent Login Activity</h3>
            `;
            
            if (sessions.length === 0) {
                sessionsList.innerHTML += '<div style="text-align: center; padding: 20px; color: #666;">No login sessions recorded</div>';
                return;
            }
            
            sessions.slice(-10).reverse().forEach(session => {
                const sessionCard = document.createElement('div');
                sessionCard.style.cssText = `
                    background: #f8f9fa;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 10px 0;
                    border-left: 4px solid #667eea;
                `;
                
                sessionCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${session.userId}</strong>
                            <p style="margin: 5px 0; color: #666;">Type: ${session.type || 'Unknown'}</p>
                        </div>
                        <div style="text-align: right; color: #666; font-size: 0.9rem;">
                            ${new Date(session.timestamp).toLocaleString()}
                        </div>
                    </div>
                `;
                
                sessionsList.appendChild(sessionCard);
            });
        }
        
        function loadUsageData() {
            const history = JSON.parse(localStorage.getItem('usage_history') || '[]');
            const usageSummary = document.getElementById('usage-summary');
            
            if (history.length === 0) {
                usageSummary.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No usage data available</div>';
                return;
            }
            
            // Calculate statistics
            const totalSessions = history.length;
            const totalWater = history.reduce((sum, entry) => sum + entry.total, 0);
            const householdSessions = history.filter(entry => entry.type === 'household').length;
            const farmerSessions = history.filter(entry => entry.type === 'farmer').length;
            const avgWaterPerSession = totalWater / totalSessions;
            
            // Recent activity
            const recentSessions = history.slice(-5).reverse();
            
            usageSummary.innerHTML = `
                <h3 style="color: #333; margin-bottom: 20px;">Water Usage Analytics</h3>
                
                <div class="stats-grid" style="margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-value">${totalSessions}</div>
                        <div class="stat-label">Total Sessions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round(totalWater)}</div>
                        <div class="stat-label">Total Water (L)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${Math.round(avgWaterPerSession)}</div>
                        <div class="stat-label">Avg per Session (L)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${householdSessions}/${farmerSessions}</div>
                        <div class="stat-label">Household/Farmer</div>
                    </div>
                </div>
                
                <h4 style="color: #667eea; margin: 20px 0 10px 0;">Recent Activity</h4>
            `;
            
            recentSessions.forEach(session => {
                const sessionCard = document.createElement('div');
                sessionCard.style.cssText = `
                    background: white;
                    border-radius: 8px;
                    padding: 15px;
                    margin: 10px 0;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
                sessionCard.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${session.type === 'household' ? 'üè†' : 'üåæ'} ${session.type.toUpperCase()}</strong>
                            <p style="margin: 5px 0; color: #666;">${Math.round(session.total)}L used (${session.items} items)</p>
                            ${session.location ? `<p style="margin: 5px 0; color: #666;">üìç ${session.location}</p>` : ''}
                        </div>
                        <div style="text-align: right; color: #666; font-size: 0.9rem;">
                            ${new Date(session.date).toLocaleDateString()}
                        </div>
                    </div>
                `;
                
                usageSummary.appendChild(sessionCard);
            });
        }
        
        function loadSystemData() {
            const systemInfo = document.getElementById('system-info');
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const history = JSON.parse(localStorage.getItem('usage_history') || '[]');
            
            // Storage usage calculation
            const storageUsed = (JSON.stringify(users).length + JSON.stringify(history).length) / 1024; // KB
            
            systemInfo.innerHTML = `
                <h3 style="color: #333; margin-bottom: 20px;">System Information</h3>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #1976d2; margin-bottom: 15px;">üìä Storage Statistics</h4>
                    <p><strong>LocalStorage Usage:</strong> ${storageUsed.toFixed(2)} KB</p>
                    <p><strong>User Data Size:</strong> ${(JSON.stringify(users).length / 1024).toFixed(2)} KB</p>
                    <p><strong>Usage History Size:</strong> ${(JSON.stringify(history).length / 1024).toFixed(2)} KB</p>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">üåê Browser Information</h4>
                    <p><strong>User Agent:</strong> ${navigator.userAgent.substring(0, 100)}...</p>
                    <p><strong>Language:</strong> ${navigator.language}</p>
                    <p><strong>Online Status:</strong> ${navigator.onLine ? '‚úÖ Online' : '‚ùå Offline'}</p>
                    <p><strong>Speech Recognition:</strong> ${'webkitSpeechRecognition' in window ? '‚úÖ Available' : '‚ùå Not Available'}</p>
                    <p><strong>Camera Access:</strong> ${navigator.mediaDevices ? '‚úÖ Available' : '‚ùå Not Available'}</p>
                </div>
                
                <div style="background: #fff3cd; padding: 20px; border-radius: 10px;">
                    <h4 style="color: #856404; margin-bottom: 15px;">‚öôÔ∏è Application Status</h4>
                    <p><strong>Current Time:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Session Start:</strong> ${new Date().toLocaleString()}</p>
                    <p><strong>Current User:</strong> ${currentUser || 'Not logged in'}</p>
                    <p><strong>User Type:</strong> ${userType || 'Not selected'}</p>
                    <p><strong>Voice Recognition:</strong> ${recognition ? '‚úÖ Active' : '‚ùå Not Initialized'}</p>
                    <p><strong>Text-to-Speech:</strong> ${'speechSynthesis' in window ? '‚úÖ Available' : '‚ùå Not Available'}</p>
                </div>
                
                <div style="background: #e8f5e8; padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <h4 style="color: #27ae60; margin-bottom: 15px;">üé§ Voice Recognition Troubleshooting</h4>
                    <button onclick="testSystemVoiceRecognition()" class="btn btn-secondary" style="margin: 5px;">
                        Test Voice Recognition
                    </button>
                    <button onclick="requestMicrophonePermission()" class="btn" style="margin: 5px;">
                        Request Mic Permission
                    </button>
                    <button onclick="reinitializeVoiceRecognition()" class="btn" style="background: #ffc107; margin: 5px;">
                        Reinitialize Voice System
                    </button>
                </div>
            `;
        }
        
        function testSystemVoiceRecognition() {
            if (!recognition) {
                showAlert('Voice recognition not initialized. Trying to reinitialize...', 'error');
                initSpeechRecognition();
                return;
            }
            
            const testText = 'Voice recognition system test';
            speak('Testing voice recognition system. Please say "hello test" after the beep sound.');
            
            setTimeout(() => {
                speak('beep'); // Audio cue
                
                setTimeout(() => {
                    if (recognition) {
                        try {
                            recognition.onresult = function(event) {
                                const result = event.results[0][0].transcript.toLowerCase();
                                if (result.includes('hello') || result.includes('test')) {
                                    showAlert('Voice recognition test PASSED! System is working correctly.', 'success');
                                    speak('Voice recognition test passed. System is working correctly.');
                                } else {
                                    showAlert(`Voice recognition working but got: "${result}". Try speaking more clearly.`, 'success');
                                    speak('Voice recognition is working. Try speaking more clearly.');
                                }
                            };
                            recognition.start();
                        } catch (error) {
                            showAlert('Voice recognition test failed: ' + error.message, 'error');
                            speak('Voice recognition test failed');
                        }
                    }
                }, 1000);
            }, 2000);
        }
        
        function reinitializeVoiceRecognition() {
            recognition = null;
            currentVoiceInput = null;
            
            // Stop any active recognition
            try {
                if (window.speechRecognition) {
                    window.speechRecognition.stop();
                }
            } catch (error) {
                console.log('No active recognition to stop');
            }
            
            showAlert('Reinitializing voice recognition system...', 'success');
            speak('Reinitializing voice recognition system');
            
            setTimeout(() => {
                initSpeechRecognition();
                if (recognition) {
                    showAlert('Voice recognition reinitialized successfully!', 'success');
                    speak('Voice recognition reinitialized successfully');
                } else {
                    showAlert('Voice recognition initialization failed. Browser may not support this feature.', 'error');
                    speak('Voice recognition initialization failed');
                }
            }, 1000);
        }
        
        function loginAsUser(userId) {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            if (!users[userId]) {
                showAlert('User not found!', 'error');
                return;
            }
            
            currentUser = userId;
            localStorage.setItem('currentUser', currentUser);
            
            // Record login session
            const sessions = JSON.parse(localStorage.getItem('login_sessions') || '[]');
            sessions.push({
                userId: userId,
                timestamp: new Date().toISOString(),
                type: userId.startsWith('camera_') ? 'camera' : 'email',
                method: 'admin_login'
            });
            localStorage.setItem('login_sessions', JSON.stringify(sessions));
            
            showAlert(`Successfully logged in as ${userId}`, 'success');
            speak(`Logged in as ${userId.startsWith('camera_') ? 'camera user' : 'email user'}`);
            
            setTimeout(() => {
                showPage('user-type-page');
            }, 2000);
        }
        
        function deleteUser(userId) {
            if (confirm(`Are you sure you want to delete user: ${userId}?`)) {
                const users = JSON.parse(localStorage.getItem('users') || '{}');
                delete users[userId];
                localStorage.setItem('users', JSON.stringify(users));
                
                if (currentUser === userId) {
                    currentUser = null;
                    localStorage.removeItem('currentUser');
                }
                
                showAlert(`User ${userId} deleted successfully`, 'success');
                loadUsersData();
            }
        }
        
        function exportAllData() {
            const users = JSON.parse(localStorage.getItem('users') || '{}');
            const history = JSON.parse(localStorage.getItem('usage_history') || '[]');
            const sessions = JSON.parse(localStorage.getItem('login_sessions') || '[]');
            
            const exportData = {
                exportDate: new Date().toISOString(),
                systemInfo: {
                    totalUsers: Object.keys(users).length,
                    totalSessions: history.length,
                    totalLoginSessions: sessions.length
                },
                users: users,
                usageHistory: history,
                loginSessions: sessions,
                farmerDatabase: farmerDatabase
            };
            
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `water_calculator_admin_export_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            showAlert('Data exported successfully!', 'success');
        }
        
        function clearAllData() {
            if (confirm('‚ö†Ô∏è WARNING: This will delete ALL user data, usage history, and login sessions. This action cannot be undone!\n\nAre you absolutely sure?')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    localStorage.clear();
                    currentUser = null;
                    userType = null;
                    currentUsage = {};
                    
                    showAlert('All data cleared successfully!', 'success');
                    speak('All data has been cleared');
                    
                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                }
            }
        }
        
        // Record login sessions
        function recordLoginSession(userId, type, method) {
            const sessions = JSON.parse(localStorage.getItem('login_sessions') || '[]');
            sessions.push({
                userId: userId,
                timestamp: new Date().toISOString(),
                type: type,
                method: method
            });
            // Keep only last 50 sessions
            if (sessions.length > 50) {
                sessions.splice(0, sessions.length - 50);
            }
            localStorage.setItem('login_sessions', JSON.stringify(sessions));
        }
        
        // Show specific crop benchmark
        function showCropBenchmark(cropKey) {
            const cropName = farmItems[cropKey].name.split('(')[0].trim();
            let searchCrop = cropName;
            
            // Map crop names to database names
            if (cropName.includes('Maize')) searchCrop = 'Maize';
            if (cropName === 'Rice') searchCrop = 'Rice';
            if (cropName === 'Wheat') searchCrop = 'Wheat';
            if (cropName === 'Cotton') searchCrop = 'Cotton';
            if (cropName === 'Sugarcane') searchCrop = 'Sugarcane';
            
            const cropFarmers = farmerDatabase.filter(f => f.crop === searchCrop);
            
            if (cropFarmers.length === 0) {
                showAlert(`No benchmark data available for ${cropName}`, 'error');
                return;
            }
            
            // Calculate crop statistics
            const avgYield = cropFarmers.reduce((sum, f) => sum + f.yield, 0) / cropFarmers.length;
            const maxYield = Math.max(...cropFarmers.map(f => f.yield));
            const minYield = Math.min(...cropFarmers.map(f => f.yield));
            const avgRainfall = cropFarmers.reduce((sum, f) => sum + f.rainfall, 0) / cropFarmers.length;
            
            // Irrigation method analysis
            const irrigationStats = {};
            cropFarmers.forEach(f => {
                if (!irrigationStats[f.irrigation]) {
                    irrigationStats[f.irrigation] = { count: 0, totalYield: 0 };
                }
                irrigationStats[f.irrigation].count++;
                irrigationStats[f.irrigation].totalYield += f.yield;
            });
            
            // Best performing regions
            const regionStats = {};
            cropFarmers.forEach(f => {
                if (!regionStats[f.location]) {
                    regionStats[f.location] = { count: 0, totalYield: 0 };
                }
                regionStats[f.location].count++;
                regionStats[f.location].totalYield += f.yield;
            });
            
            const topRegions = Object.entries(regionStats)
                .map(([region, stats]) => ({
                    region,
                    avgYield: Math.round(stats.totalYield / stats.count)
                }))
                .sort((a, b) => b.avgYield - a.avgYield)
                .slice(0, 3);
            
            // Create popup
            const popup = document.createElement('div');
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 1000;
            `;
            
            const content = document.createElement('div');
            content.style.cssText = `
                background: white;
                border-radius: 15px;
                padding: 30px;
                max-width: 700px;
                max-height: 80vh;
                overflow-y: auto;
                position: relative;
            `;
            
            let irrigationAnalysis = '<h4 style="color: #667eea; margin: 15px 0 10px 0;">üöø Irrigation Method Performance</h4>';
            Object.entries(irrigationStats).forEach(([method, stats]) => {
                const avgYield = Math.round(stats.totalYield / stats.count);
                const efficiency = method === 'Drip Irrigation' ? '‚≠ê Most Efficient' : 
                                 method === 'Sprinkler' ? '‚ö° Moderate Efficiency' :
                                 method === 'Canal Irrigation' ? 'üíß Traditional' : 'üåä High Water Use';
                irrigationAnalysis += `
                    <div style="background: #f8f9fa; padding: 10px; margin: 5px 0; border-radius: 5px;">
                        <strong>${method}</strong> ${efficiency}<br>
                        <small>${stats.count} farmers, Avg yield: ${avgYield} kg</small>
                    </div>
                `;
            });
            
            let regionAnalysis = '<h4 style="color: #27ae60; margin: 15px 0 10px 0;">üèÜ Top Performing Regions</h4>';
            topRegions.forEach((region, index) => {
                const medal = index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : 'ü•â';
                regionAnalysis += `
                    <div style="background: #e8f5e8; padding: 10px; margin: 5px 0; border-radius: 5px;">
                        ${medal} <strong>${region.region}:</strong> ${region.avgYield} kg average yield
                    </div>
                `;
            });
            
            content.innerHTML = `
                <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; background: #dc3545; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; cursor: pointer;">√ó</button>
                <h3 style="color: #333; margin-bottom: 20px;">üìà ${cropName} Performance Analysis</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">Average Yield</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #1976d2;">${Math.round(avgYield)} kg</div>
                    </div>
                    <div style="background: #e8f5e8; padding: 15px; border-radius: 8px; text-align: center;">
                        <h4 style="color: #27ae60; margin-bottom: 10px;">Best Yield</h4>
                        <div style="font-size: 2rem; font-weight: bold; color: #27ae60;">${maxYield} kg</div>
                    </div>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                    <h4 style="color: #856404; margin-bottom: 10px;">üìä Crop Statistics</h4>
                    <p><strong>Farmers in database:</strong> ${cropFarmers.length}</p>
                    <p><strong>Yield range:</strong> ${minYield} - ${maxYield} kg</p>
                    <p><strong>Average rainfall:</strong> ${Math.round(avgRainfall)} mm</p>
                    <p><strong>Water requirement:</strong> ${farmItems[cropKey].water}L per kg (Standard)</p>
                </div>
                
                ${irrigationAnalysis}
                ${regionAnalysis}
                
                <div style="margin-top: 20px; padding: 15px; background: #ffeaa7; border-radius: 8px;">
                    <h4 style="color: #d63031;">üéØ Your Goal</h4>
                    <p>Try to achieve yields above ${Math.round(avgYield)} kg while using efficient irrigation methods like drip irrigation to minimize water usage.</p>
                </div>
            `;
            
            popup.appendChild(content);
            document.body.appendChild(popup);
        }
        function calculateUsage() {
            const items = userType === 'household' ? householdItems : farmItems;
            let totalUsage = 0;
            let efficientUsage = 0;
            let itemsUsed = 0;
            
            currentUsage = {};
            
            Object.keys(items).forEach(key => {
                const quantity = parseFloat(document.getElementById(key + '-quantity').value || 0);
                if (quantity > 0) {
                    const usage = quantity * items[key].water;
                    const efficient = quantity * items[key].efficient;
                    totalUsage += usage;
                    efficientUsage += efficient;
                    itemsUsed++;
                    
                    currentUsage[key] = {
                        quantity: quantity,
                        usage: usage,
                        efficient: efficient,
                        name: items[key].name
                    };
                }
            });
            
            // Store usage data
            const usageData = {
                date: new Date().toISOString().split('T')[0],
                type: userType,
                total: totalUsage,
                efficient: efficientUsage,
                items: itemsUsed,
                details: currentUsage
            };
            
            // Save to history
            const history = JSON.parse(localStorage.getItem('usage_history') || '[]');
            history.push(usageData);
            localStorage.setItem('usage_history', JSON.stringify(history));
            
            // Show dashboard
            updateDashboard('daily', totalUsage, efficientUsage, itemsUsed);
            showPage('dashboard-page');
        }
        
        // Enhanced suggestions with plant-specific advice
        function generateSuggestions(total, efficient) {
            const suggestionsList = document.getElementById('suggestions-list');
            const savings = total - efficient;
            const savingsPercentage = ((savings / total) * 100).toFixed(1);
            
            const suggestions = [];
            
            if (userType === 'household') {
                if (currentUsage.shower && currentUsage.shower.quantity > 1) {
                    suggestions.push('Reduce shower time to 5-7 minutes to save up to 50 liters per shower');
                }
                if (currentUsage.laundry && currentUsage.laundry.quantity > 0) {
                    suggestions.push('Use full loads in washing machine and choose eco-mode to save 50L per load');
                }
                if (currentUsage.dish_washing && currentUsage.dish_washing.quantity > 0) {
                    suggestions.push('Use dishwasher instead of hand washing to save 10-15L per session');
                }
                if (currentUsage.garden_watering && currentUsage.garden_watering.quantity > 0) {
                    suggestions.push('Water plants early morning or evening to reduce evaporation losses');
                }
                if (currentUsage.car_wash && currentUsage.car_wash.quantity > 0) {
                    suggestions.push('Use bucket instead of hose for car washing to save 100L per wash');
                }
            } else {
                // Plant-specific suggestions
                const irrigationMethod = document.getElementById('irrigation-method')?.value;
                const irrigationMultiplier = irrigationMethod ? (irrigationEfficiency[irrigationMethod] || 1.0) : 1.0;
                
                // Irrigation efficiency suggestions
                if (irrigationMultiplier > 1.5) {
                    suggestions.push(`Switch from ${irrigationMethod} to drip irrigation to save ${((irrigationMultiplier - 1.0) * 100).toFixed(0)}% water`);
                } else if (irrigationMultiplier > 1.2) {
                    suggestions.push(`Consider upgrading to drip irrigation to save ${((irrigationMultiplier - 1.0) * 100).toFixed(0)}% water`);
                } else if (irrigationMultiplier === 1.0) {
                    suggestions.push('Excellent choice using drip irrigation - the most water-efficient method');
                }
                
                // Plant grouping suggestions
                const highWaterPlants = Object.keys(currentUsage).filter(key => 
                    farmItems[key] && farmItems[key].water > 0.4 && currentUsage[key].quantity > 0
                );
                
                const lowWaterPlants = Object.keys(currentUsage).filter(key => 
                    farmItems[key] && farmItems[key].water <= 0.2 && currentUsage[key].quantity > 0
                );
                
                if (highWaterPlants.length > 0) {
                    const plantNames = highWaterPlants.map(key => farmItems[key].name).join(', ');
                    suggestions.push(`Your high-water plants (${plantNames}) benefit most from mulching and shade during hot periods`);
                }
                
                if (lowWaterPlants.length > 0) {
                    const plantNames = lowWaterPlants.map(key => farmItems[key].name).join(', ');
                    suggestions.push(`Great choice growing drought-tolerant plants like ${plantNames} - they require minimal water`);
                }
                
                // Seasonal suggestions
                const totalPlants = Object.values(currentUsage).reduce((sum, item) => sum + item.quantity, 0);
                if (totalPlants > 50) {
                    suggestions.push('Consider installing a rainwater harvesting system for your large garden');
                    suggestions.push('Use soil moisture sensors to avoid overwatering with so many plants');
                } else if (totalPlants > 20) {
                    suggestions.push('Group plants with similar water needs together for efficient watering');
                }
                
                // Specific plant care suggestions
                if (currentUsage.tomato || currentUsage.cucumber || currentUsage.eggplant) {
                    suggestions.push('Fruiting plants like tomatoes and cucumbers need consistent moisture - consider drip irrigation with timers');
                }
                
                if (currentUsage.basil || currentUsage.mint || currentUsage.cilantro) {
                    suggestions.push('Herbs like basil and mint prefer morning watering and good drainage to prevent root rot');
                }
                
                if (currentUsage.lettuce || currentUsage.spinach || currentUsage.arugula) {
                    suggestions.push('Leafy greens benefit from frequent, light watering rather than deep, infrequent watering');
                }
                
                // Water conservation techniques
                suggestions.push('Apply organic mulch around plants to reduce water evaporation by 25%');
                suggestions.push('Water early morning (6-8 AM) to minimize evaporation losses');
                suggestions.push('Use companion planting - taller plants can shade shorter, water-sensitive ones');
            }
            
            // Add general suggestions
            suggestions.push(`You can save ${savings.toFixed(1)} liters (${savingsPercentage}%) by adopting efficient practices`);
            suggestions.push('Monitor soil moisture before watering to prevent overwatering');
            suggestions.push('Consider drought-resistant varieties for your next planting season');
            
            suggestionsList.innerHTML = '';
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                suggestionsList.appendChild(li);
            });
        }
        
        // Update dashboard with real-time data integration
        function updateDashboard(period, total, efficient, items) {
            document.getElementById('total-usage').textContent = Math.round(total);
            document.getElementById('efficiency-score').textContent = Math.round((efficient / total) * 100) + '%';
            document.getElementById('savings-potential').textContent = Math.round(total - efficient);
            document.getElementById('items-tracked').textContent = items;
            
            // Add real-time weather card if weather data is available
            addWeatherDashboardCard();
            
            generateSuggestions(total, efficient);
        }
        
        function addWeatherDashboardCard() {
            // Remove existing weather card if present
            const existingWeatherCard = document.getElementById('weather-dashboard-card');
            if (existingWeatherCard) {
                existingWeatherCard.remove();
            }
            
            if (weatherData && soilMoistureData) {
                const statsGrid = document.querySelector('.stats-grid');
                if (statsGrid) {
                    const weatherCard = document.createElement('div');
                    weatherCard.id = 'weather-dashboard-card';
                    weatherCard.className = 'stat-card';
                    weatherCard.style.gridColumn = 'span 2';
                    weatherCard.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    weatherCard.style.color = 'white';
                    
                    weatherCard.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h4 style="margin: 0; color: white;">üå°Ô∏è Live Conditions</h4>
                            <button onclick="refreshWeatherData()" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 5px 10px; border-radius: 15px; font-size: 0.8rem; cursor: pointer;">
                                üîÑ Refresh
                            </button>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; font-size: 0.9rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${weatherData.temp}¬∞C</div>
                                <div style="opacity: 0.9;">Temperature</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${soilMoistureData.moisture}%</div>
                                <div style="opacity: 0.9;">Soil Moisture</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold;">${weatherData.humidity}%</div>
                                <div style="opacity: 0.9;">Humidity</div>
                            </div>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center; font-size: 0.9rem;">
                            ${weatherData.condition} ‚Ä¢ ${weatherData.precipitation}mm rain ‚Ä¢ ${weatherData.windSpeed} km/h wind
                        </div>
                    `;
                    
                    statsGrid.appendChild(weatherCard);
                }
            }
        }
        
        // Generate enhanced water conservation suggestions
        function generateSuggestions(total, efficient) {
            const suggestionsList = document.getElementById('suggestions-list');
            const savings = total - efficient;
            const savingsPercentage = ((savings / total) * 100).toFixed(1);
            
            const suggestions = [];
            
            if (userType === 'household') {
                if (currentUsage.shower && currentUsage.shower.quantity > 1) {
                    suggestions.push('Reduce shower time to 5-7 minutes to save up to 50 liters per shower');
                }
                if (currentUsage.laundry && currentUsage.laundry.quantity > 0) {
                    suggestions.push('Use full loads in washing machine and choose eco-mode to save 50L per load');
                }
                if (currentUsage.dish_washing && currentUsage.dish_washing.quantity > 0) {
                    suggestions.push('Use dishwasher instead of hand washing to save 10-15L per session');
                }
                if (currentUsage.garden_watering && currentUsage.garden_watering.quantity > 0) {
                    suggestions.push('Water plants early morning or evening to reduce evaporation losses');
                }
                if (currentUsage.car_wash && currentUsage.car_wash.quantity > 0) {
                    suggestions.push('Use bucket instead of hose for car washing to save 100L per wash');
                }
            } else {
                // Enhanced suggestions with real-time weather integration
                const irrigationMethod = document.getElementById('irrigation-method')?.value;
                const irrigationMultiplier = irrigationMethod ? (irrigationEfficiency[irrigationMethod] || 1.0) : 1.0;
                
                // Weather-based irrigation suggestions
                if (weatherData) {
                    if (weatherData.temp > 35) {
                        suggestions.push(`High temperature (${weatherData.temp}¬∞C) detected - consider increasing watering frequency and using shade cloth`);
                    }
                    
                    if (weatherData.precipitation > 10) {
                        suggestions.push(`Recent rainfall (${weatherData.precipitation}mm) - reduce watering today and check soil moisture before next watering`);
                    }
                    
                    if (weatherData.humidity > 80) {
                        suggestions.push(`High humidity (${weatherData.humidity}%) - ensure good air circulation and avoid evening watering to prevent fungal diseases`);
                    }
                    
                    if (weatherData.windSpeed > 15) {
                        suggestions.push(`High wind conditions (${weatherData.windSpeed} km/h) - avoid overhead sprinklers, use drip irrigation instead`);
                    }
                }
                
                // Soil moisture-based suggestions
                if (soilMoistureData) {
                    if (soilMoistureData.moisture < 30) {
                        suggestions.push(`Low soil moisture detected (${soilMoistureData.moisture}%) - immediate watering recommended for optimal plant health`);
                    } else if (soilMoistureData.moisture > 70) {
                        suggestions.push(`High soil moisture (${soilMoistureData.moisture}%) - skip watering for 1-2 days to prevent root rot`);
                    } else {
                        suggestions.push(`Optimal soil moisture (${soilMoistureData.moisture}%) - maintain current watering schedule`);
                    }
                }
                
                // Real-time irrigation efficiency suggestions
                if (irrigationMultiplier > 1.5) {
                    const potentialSavings = ((irrigationMultiplier - 1.0) * total).toFixed(1);
                    suggestions.push(`Switch from ${irrigationMethod} to drip irrigation to save ${potentialSavings}L based on current weather conditions`);
                } else if (irrigationMultiplier > 1.2) {
                    suggestions.push(`Consider upgrading to drip irrigation - especially beneficial in current ${weatherData?.condition || 'weather'} conditions`);
                } else if (irrigationMultiplier === 1.0) {
                    suggestions.push('Excellent choice using drip irrigation - optimal efficiency for current conditions');
                }
                
                // General farming suggestions
                suggestions.push('Install soil moisture sensors to optimize irrigation timing');
                suggestions.push('Use mulching to reduce water evaporation from soil by up to 25%');
            }
            
            // Add general suggestions
            suggestions.push(`You can save ${savings.toFixed(0)} liters (${savingsPercentage}%) by adopting efficient practices`);
            suggestions.push('Monitor usage regularly to identify improvement opportunities');
            suggestions.push('Set daily/weekly water usage targets to track progress');
            
            suggestionsList.innerHTML = '';
            suggestions.forEach(suggestion => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                suggestionsList.appendChild(li);
            });
        }
        
        // Dashboard tab switching
        function showDashboardTab(period) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            const history = JSON.parse(localStorage.getItem('usage_history') || '[]');
            const currentDate = new Date();
            let filteredData = [];
            
            switch(period) {
                case 'daily':
                    filteredData = history.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.toDateString() === currentDate.toDateString();
                    });
                    break;
                case 'weekly':
                    const weekAgo = new Date(currentDate.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filteredData = history.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate >= weekAgo;
                    });
                    break;
                case 'monthly':
                    filteredData = history.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getMonth() === currentDate.getMonth() && 
                               entryDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
                case 'yearly':
                    filteredData = history.filter(entry => {
                        const entryDate = new Date(entry.date);
                        return entryDate.getFullYear() === currentDate.getFullYear();
                    });
                    break;
            }
            
            const totalUsage = filteredData.reduce((sum, entry) => sum + entry.total, 0);
            const totalEfficient = filteredData.reduce((sum, entry) => sum + entry.efficient, 0);
            const totalItems = filteredData.reduce((sum, entry) => sum + entry.items, 0);
            
            updateDashboard(period, totalUsage, totalEfficient, totalItems);
        }
        
        // Go back to items page
        function goBackToItems() {
            if (userType === 'household') {
                showPage('household-page');
            } else {
                showPage('farmer-page');
            }
        }
        
        // Show alert messages
        function showAlert(message, type) {
            // Remove existing alerts
            const existingAlert = document.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            
            const container = document.querySelector('.page.active');
            container.insertBefore(alert, container.firstChild);
            
            // Remove alert after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
        
        // Initialize application
        function initApp() {
            initSpeechRecognition();
            
            // Check if user is already logged in
            const lastUser = localStorage.getItem('currentUser');
            if (lastUser) {
                currentUser = lastUser;
                showPage('user-type-page');
            }
            
            // Speak welcome message
            setTimeout(() => {
                speak('Welcome to Water Footprint Calculator. Please register or login to continue.');
            }, 1000);
        }
        
        // Save current user
        function saveCurrentUser() {
            if (currentUser) {
                localStorage.setItem('currentUser', currentUser);
            }
        }
        
        // Enhanced voice recognition for quantity inputs
        function setupVoiceInputs() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('voice-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const input = e.target.parentNode.querySelector('input[type="number"]');
                    if (input && !e.target.classList.contains('active')) {
                        startVoiceInput(input);
                    } else if (e.target.classList.contains('active')) {
                        stopVoiceInput();
                    }
                }
            });
            
            // Add voice test button in admin panel
            addVoiceTestFeature();
        }
        
        // Add voice recognition test feature
        function addVoiceTestFeature() {
            if (document.getElementById('voice-test-section')) return; // Already added
            
            const welcomePage = document.getElementById('welcome-page');
            if (!welcomePage) return;
            
            const testSection = document.createElement('div');
            testSection.id = 'voice-test-section';
            testSection.style.cssText = `
                margin-top: 20px;
                padding: 20px;
                background: #f8f9fa;
                border-radius: 10px;
                text-align: center;
            `;
            
            testSection.innerHTML = `
                <h4 style="color: #667eea; margin-bottom: 15px;">Voice Recognition Test</h4>
                <input type="text" id="voice-test-input" placeholder="Click microphone to test voice input" 
                       style="width: 70%; padding: 10px; margin-right: 10px; border-radius: 5px; border: 1px solid #ddd;">
                <button class="voice-btn" onclick="testVoiceRecognition()" title="Test voice input">üé§</button>
                <button class="btn btn-secondary" onclick="requestMicrophonePermission()" 
                        style="margin-left: 10px; padding: 10px 15px; font-size: 0.9rem;">
                    üîß Request Mic Permission
                </button>
            `;
            
            welcomePage.appendChild(testSection);
        }
        
        function testVoiceRecognition() {
            const testInput = document.getElementById('voice-test-input');
            if (testInput) {
                startVoiceInput(testInput);
            }
        }
        
        async function requestMicrophonePermission() {
            try {
                showAlert('Requesting microphone permission...', 'success');
                
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Stop the stream immediately - we just needed permission
                stream.getTracks().forEach(track => track.stop());
                
                showAlert('Microphone permission granted! Voice recognition should now work.', 'success');
                speak('Microphone permission granted. Voice recognition is ready to use.');
                
                // Reinitialize speech recognition
                initSpeechRecognition();
                
            } catch (error) {
                console.error('Microphone permission error:', error);
                let errorMessage = 'Microphone access denied';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage = 'Microphone permission denied. Please allow microphone access in your browser settings and try again.';
                } else if (error.name === 'NotFoundError') {
                    errorMessage = 'No microphone found. Please check your audio devices.';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage = 'Microphone access not supported in this browser.';
                }
                
                showAlert(errorMessage, 'error');
                speak(errorMessage);
            }
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            initApp();
            setupVoiceInputs();
        });
        
        // Add CSS for achievement animation
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from {
                    transform: translateX(100%);
                    opacity: 0;
                }
                to {
                    transform: translateX(0);
                    opacity: 1;
                }
            }
            
            .pulse-button {
                animation: pulse 2s infinite;
            }
            
            @keyframes pulse {
                0% {
                    box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
                }
                70% {
                    box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
                }
                100% {
                    box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
                }
            }
        `;
        document.head.appendChild(style);
        
    </script>
</body>
</html>